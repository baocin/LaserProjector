<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Laser Projector Control</title>
  <meta name="description" content="Laser">
  <meta name="author" content="SitePoint">

  <link rel="stylesheet" href="css/styles.css?v=1.0">

  <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
  <![endif]-->
</head>

<body>
    <canvas id="screen" width="255" height="255" style="border:1px solid #000000;"></canvas>
    <button id="drawButton">dslkfj</button>
    <button id="clearScreenButton">Clear Screen</button>
  <script src="js/opentype.min.js"></script>
  <script src="js/reqwest.js"></script>
  <script src="js/main.js"></script>
  <script>

    (function() {
    opentype.load('fonts/Brain_Flower.ttf', function(err, font) {
    if (err) {
         console.log('Font could not be loaded: ' + err);
    } else {
        var ctx = document.getElementById('screen').getContext('2d');
        // Construct a Path object containing the letter shapes of the given text.
        // The other parameters are x, y and fontSize.
        // Note that y is the position of the baseline.
        var path = font.getPath('Hello, World!', 0, 150, 50);
        // If you just want to draw the text you can also use font.draw(ctx, text, x, y, fontSize).
        path.draw(ctx);
    }

    });


    // document.getElementById("clearScreenButton").addEventListener("click", function(ev){
    //         var url = 'http://192.168.1.147/screen/frame/clear'
    //         var request = new Http.Get(url, false);
    //         request.start().then(function(response){
    //             console.log(response);
    //         });
    // });
    document.getElementById("drawButton").addEventListener("click", function(ev){
        var ctx = document.getElementById('screen').getContext('2d');
var imgData = ctx.getImageData(0,0,255,255).data;
        
        var result = {};
               
        result["frameId"] = 11;
        result["points"] = [];

        reqwest({
            url: 'http://192.168.1.147/frame/add',
            method: 'get',
            data: {"payload": result, "visible": true},
            success: function(resp){
                console.log(resp);
            }
        })


        for (var i = 0; i < imgData.length; i += 4){
            var width = 255;
            var x = (i / 4) % width;
            var y = Math.floor((i / 4) / width);
            //{"x":100, "y":100, "z":0, "r":100,"g":100,"b":100},
            var point = {};
            point["x"] = x;
            point["y"] = y;
            point["z"] = 0;
            point["r"] = imgData[i];
            point["g"] = imgData[i+1];
            point["b"] = imgData[i+2];
            
            
            // if (point["r"] == 0 && point["g"] == 0 && point["b"] == 0){
                
            // }else{
            if (imgData[i+3] > 250){
                // console.log(point["r"] + " " +  point["g"] + " " + point["b"]);
                // result["points"] = result["points"] + point;
                // result["points"].push(point);

                console.log(point);
                reqwest({
                    url: 'http://192.168.1.147/points/add',
                    method: 'post',
                    // type: 'json',
                    contentType: 'application/x-www-form-urlencoded',
                    
                    data: {"payload": point, "frameId": 11},
                    success: function(resp){
                        console.log(resp);
                    }
                })

            }
            // point["r"] = imgData.data[i+3];
            
        }

        console.log(result);

// var url = '192.168.1.147/frame/add?payload={"frameId":66, points": [{"x":100, "y":100, "z":0, "r":100,"g":100,"b":100}, {"x":100, "y":100, "z":0, "r":100,"g":100,"b":100},{"x":100, "y":100, "z":0, "r":100,"g":100,"b":100},{"x":100, "y":100, "z":0, "r":100,"g":100,"b":100}]}&visible'


// var request = new Http.Get(url, false);
// request.data = d;
// request.start().then(function(response){
//     console.log("send info to esp")
//     console.log(response);
// });



    }, false);

})();

  </script>
</body>
</html>